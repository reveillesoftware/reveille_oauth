<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://alcdn.msauth.net; connect-src 'self' https://oauth2.googleapis.com http://seveniron"  />
    <meta charset="utf-8" />
    <title>Azure API</title>
    <style>
        body {
            font-family: Arial;
            font-size:14px;
        }
        .f-bold{
            font-weight:bold;
        }
        .d-none{
            display:none;
        }
    </style>
</head>
<body>
    <div style="margin-left:2em;">
        <div class="f-bold" style=margin-bottom:1em;>AZURE Test</div>
        <div class="f-bold">Discovery Document</div>
        <div>
            <input id="dicoverydoc" style="width:50em" type="text" title="V2 discovery document url. Format should be https://login.microsoftonline/com/{tenantid}/V2.0/.well-known/openid-configurnation"/>
      </div>
        <div id="userid" style="margin-top:1em;"></div>
        <div class="f-bold" style="margin-top:1em;">Client ID</div>
        <input type="text" id="clientid" style="width:50em;" value=""" />
        <div class="f-bold" style="margin-top:1em;">Tenant ID</div>
        <input type="text" id="tenantid" style="width:50em;" value=""" />
        <div class="f-bold" style="margin-top:1em;">Target API (Must get a GET type)</div>
        <input type="text" id="testapi" style="width:50em;" value="http://seveniron/reveilleuseranalytics/api/applications" />

        <div id="lbluserid" style="margin-top:1em"></div>
        <div style="margin-top:2em">
            <button  id="btnlogin">Login</button>
            <button disabled id="btntestapi" style="margin-left:2em;">Test API</button>
        </div>
        <div id="lblaccesstoken" class="f-bold d-none" style="margin-top:3em">Access Token</div>
        <div id="accesstoken" style="word-break:break-all;"></div>
        <div id="lblexpires" class="f-bold d-none" style="margin-top:1em">Access Token Expires</div>
        <div id="tokenexpires"></div>
        <div id="lblidtoken" class="f-bold d-none" style="margin-top:2em;">ID Token</div>
        <div style="display:flex;width:100%;">
            <div id="idtoken" style="width:45%;margin-right:5%;word-break:break-all;"></div>
            <div id="tokenvals" style="width:45%"></div>
        </div>
    </div>
</body>
<script src="https://alcdn.msauth.net/browser/2.0.0-beta.4/js/msal-browser.js" integrity="sha384-7sxY2tN3GMVE5jXH2RL9AdbO6s46vUh9lUid4yNCHJMUzDoj+0N4ve6rLOmR88yN" crossorigin="anonymous"></script>

<script>
var azureMsal;
window.addEventListener('load', () => initApp());
function initApp()
{
    console.log('init app');
    const clientIdValue = window.localStorage.getItem('azure_clientid');
    document.getElementById('clientid').value = clientIdValue === null ? '' : clientIdValue;
    const tenantid = window.localStorage.getItem('azure_tenantid');
    document.getElementById('tenantid').value = tenantid === null ? '' : tenantid;
    document.getElementById('btnlogin').addEventListener('click', () => doLogin());
    if (clientIdValue.length > 0){
        const msalConfig = {
            auth: {
                clientId: clientIdValue,
                redirectUri: 'http://localhost/TYF/'
            },
            cache:{
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false
            }
        }
        azureMsal = new msal.PublicClientApplication(msalConfig); 

    }

}
async function doLogin(){
   const clientId = document.getElementById('clientid').value;
   if (clientid.length === 0)
   {
       alert('client ID needs to be entered');
       return;
   }
   window.localStorage.setItem('azure_clientid',clientId);
   const loginRequest = {
       scopes:["User.read"]
   }
   debugger;
   return azureMsal.loginPopup(loginRequest).then((resp) => handleLoginResponse(resp)).catch((error) => alert(`Loginpopup error: ${error}`));

}
function handleLoginResponse(resp){ 
    debugger;
    if (resp !== null){
        document.getElementById('lbluserid').innerText = `Loggin in as ${resp.account.username}`
    } else{
        const currentAccounts = azureMsal.getAllAccounts();
        debugger;
    }
}

</script> 
</html>